<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manage Kafka Streams - menziess blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,700|Lora:400,700|Fira+Code:300,400">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msvalidate.01" content="DF64D3472558D82FA059638FC476FF14">
  <meta name="msapplication-TileColor" content="#603cba">
  <meta name="theme-color" content="#ffffff">

  
  
  
    
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-157518256-1"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-157518256-1');
      </script>
    
  

  
  
  <link rel="stylesheet" href="/css/style.min.b4f1391d3bcccc695f42caa9da7c92b8738667b18c73d3784e61b89718ef6075.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-posts">
      <a href="/howto/">
        <span>Posts</span>
      </a>
    </li>
    
    <li class="menu-item-tags">
      <a href="/tags/">
        <span>Tags</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://menziess.github.io/howto"><img draggable="false" alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://menziess.github.io/howto"><img draggable="false" alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-posts">
      <a href="/howto/">
        <span>Posts</span>
      </a>
    </li>
    
    <li class="menu-item-tags">
      <a href="/tags/">
        <span>Tags</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <h4>Howto</h4>

  
  <ul>
    
    <li class="">
      <a href="https://menziess.github.io/howto/use/snapstream/">Use Snapstream</a>
    </li>
    
    <li class="active ">
      <a href="https://menziess.github.io/howto/manage/kafka-streams/">Manage Kafka Streams</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/create/python-executables/">Create Python Executables</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/use/key-vault-secrets-in-data-factory/">Use Key Vault Secrets In Data Factory</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/python-packages-from-azure-devops/">Install Python Packages From Azure DevOps</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/python-packages-on-azure-synapse/">Install Python Packages on Azure Synapse</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/python-packages-on-databricks/">Install Python Packages on Databricks</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/run/gui-apps-with-docker/">Run GUI Apps With Docker</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/run/databricks-notebooks-from-devops/">Run Databricks Notebooks from DevOps</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/parameterize/databricks-notebooks/">Parameterize Databricks Notebooks</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/use/functional-programming-in-python/">Use Functional Programming In Python</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/enhance/your-databricks-workflow/">Enhance Your Databricks Workflow</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/create/python-packages/">Create Python Packages</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/enhance/your-python-vscode-workflow/">Enhance Your Python-vscode Workflow</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/databricks-connect/">Install databricks-connect</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/windows-subsystem-for-linux/">Install Windows Subsystem for Linux</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/test/python-code/">Test Python Code</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/test/code-in-databricks-notebooks/">Test Code in Databricks Notebooks</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/manage/virtual-environments/">Manage Virtual Environments</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/manage/python-versions/">Manage Python Versions</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/create/a-blog/">Create a Blog</a>
    </li>
    
  </ul>
  

</div>

          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Manage Kafka Streams</h1>
<div class="pb-2 content anchor-link-enabled">
  <p>Processing messages from Kafka is relatively easy, but common errors can easily be avoided by having a better understanding of how Kafka works internally. We&rsquo;ll process messages from the start of the topic, and see how Kafka handles offsets step by step.</p>
<p><img src="/images/logo/kafka.png#logo" alt=""></p>
<h2 id="basic-setup">Basic Setup</h2>
<p>Create a <a href="https://menziess.github.io/howto/manage/virtual-environments/">virtual environment</a> and install the following dependencies:</p>
<ul>
<li>jupyter</li>
<li>kafka-python</li>
</ul>
<p>Make sure that <code>docker</code> is installed, then create a <code>docker-compose.yml</code> file with the following contents:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.6&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">zookeeper</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">confluentinc/cp-zookeeper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">zookeeper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">zookeeper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;2181:2181&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ZOOKEEPER_CLIENT_PORT</span><span class="p">:</span><span class="w"> </span><span class="m">2181</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ZOOKEEPER_TICK_TIME</span><span class="p">:</span><span class="w"> </span><span class="m">2000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">broker</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">confluentinc/cp-kafka</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">broker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">broker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">zookeeper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;29091:29091&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">KAFKA_BROKER_ID</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">KAFKA_ZOOKEEPER_CONNECT</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;zookeeper:2181&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class="p">:</span><span class="w"> </span><span class="l">PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">KAFKA_ADVERTISED_LISTENERS</span><span class="p">:</span><span class="w"> </span><span class="l">PLAINTEXT://broker:9091,PLAINTEXT_HOST://localhost:29091</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">KAFKA_TRANSACTION_STATE_LOG_MIN_ISR</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">healthcheck</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">test</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;CMD&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;kafka-topics&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;--list&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;--bootstrap-server&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;localhost:9091&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">10s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span></code></pre></div><p>Spin up your Kafka cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker-compose up
</span></span></code></pre></div><p>Create two jupyter notebooks: <code>producer.ipynb</code> and <code>consumer.ipynb</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># producer.ipynb</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="n">KafkaProducer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;bootstrap_servers&#39;</span><span class="p">:</span> <span class="s1">&#39;localhost:29091&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;security_protocol&#39;</span><span class="p">:</span> <span class="s1">&#39;PLAINTEXT&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">KafkaProducer</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># consumer.ipynb</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="n">KafkaConsumer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;bootstrap_servers&#39;</span><span class="p">:</span> <span class="s1">&#39;localhost:29091&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;security_protocol&#39;</span><span class="p">:</span> <span class="s1">&#39;PLAINTEXT&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;group_id&#39;: &#39;test&#39;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#39;auto_offset_reset&#39;: &#39;earliest&#39;,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="n">KafkaConsumer</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>  <span class="c1"># subscribing to Kafka topic &#39;test&#39;</span>
</span></span></code></pre></div><h2 id="offsets">Offsets</h2>
<p>Let&rsquo;s start sending data, add a cell to <code>producer.ipynb</code> and send one message to Kafka:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;123&#39;</span><span class="p">)</span>  <span class="c1"># Sending message to topic &#39;test&#39;</span>
</span></span></code></pre></div><p>In <code>consumer.ipynb</code> add a cell with the following code to start reading from the <code>test</code> topic:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">pass</span>
</span></span></code></pre></div><p>You&rsquo;ll see zero output messages. That is because our consumer starts reading as of now, and it won&rsquo;t process the messages on the backlog.</p>
<p>Send an additional message in a new cell:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;456&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>This time you will see the message in the output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">ConsumerRecord</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="s1">&#39;test&#39;</span> <span class="n">partition</span><span class="o">=</span><span class="mi">0</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span> <span class="n">timestamp</span><span class="o">=</span><span class="mf">1665395214.</span><span class="o">..</span> <span class="n">timestamp_type</span><span class="o">=</span><span class="mi">0</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span> <span class="n">value</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;456&#39;</span> <span class="n">headers</span><span class="o">=</span><span class="p">[]</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">None</span> <span class="n">serialized_key_size</span><span class="o">=-</span><span class="mi">1</span> <span class="n">serialized_value_size</span><span class="o">=</span><span class="mi">3</span> <span class="n">serialized_header_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></div><p>Now change the code to:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">c</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>               <span class="c1"># triggers creation of consumer group</span>
</span></span><span class="line"><span class="cl"><span class="n">c</span><span class="o">.</span><span class="n">seek_to_beginning</span><span class="p">()</span>  <span class="c1"># moves to beginning of the topic</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">pass</span>
</span></span></code></pre></div><p>This time you will see both messages:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">ConsumerRecord</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="s1">&#39;test&#39;</span> <span class="n">partition</span><span class="o">=</span><span class="mi">0</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span> <span class="n">timestamp</span><span class="o">=</span><span class="mf">1665395214.</span><span class="o">..</span> <span class="n">timestamp_type</span><span class="o">=</span><span class="mi">0</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span> <span class="n">value</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;123&#39;</span> <span class="n">headers</span><span class="o">=</span><span class="p">[]</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">None</span> <span class="n">serialized_key_size</span><span class="o">=-</span><span class="mi">1</span> <span class="n">serialized_value_size</span><span class="o">=</span><span class="mi">3</span> <span class="n">serialized_header_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ConsumerRecord</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="s1">&#39;test&#39;</span> <span class="n">partition</span><span class="o">=</span><span class="mi">0</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span> <span class="n">timestamp</span><span class="o">=</span><span class="mf">1665395214.</span><span class="o">..</span> <span class="n">timestamp_type</span><span class="o">=</span><span class="mi">0</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span> <span class="n">value</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;456&#39;</span> <span class="n">headers</span><span class="o">=</span><span class="p">[]</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">None</span> <span class="n">serialized_key_size</span><span class="o">=-</span><span class="mi">1</span> <span class="n">serialized_value_size</span><span class="o">=</span><span class="mi">3</span> <span class="n">serialized_header_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></div><p>Each message has an offset, we just started reading from offset 0. The offset can be used by the application to continue where it left off after it restarts (or crashes).</p>
<h2 id="consumer-groups">Consumer Groups</h2>
<p>Kafka stores this offset for you if you provide a (consumer) <code>group_id</code>. Uncomment the line in your consumer config:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="s1">&#39;group_id&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
</span></span></code></pre></div><p>Change your code back to:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">pass</span>
</span></span></code></pre></div><p>Again, there is no output data.</p>
<p>Because this is a new consumer group, there&rsquo;s no offset stored, so it starts at the &ldquo;latest&rdquo; offset by default (this is the case for this library: <code>kafka-python</code>).</p>
<p>This can be changed by setting the <code>auto_offset_reset</code> configuration property to &ldquo;earliest&rdquo;. Other than that, it&rsquo;s possible to manually select the starting offset regardless of whether the consumer group offset was stored or not:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">start_at_beginning</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">start_at_beginning</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">c</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>               <span class="c1"># triggers creation of consumer group</span>
</span></span><span class="line"><span class="cl">  <span class="n">c</span><span class="o">.</span><span class="n">seek_to_beginning</span><span class="p">()</span>  <span class="c1"># moves to beginning of the topic</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">pass</span>
</span></span></code></pre></div><h2 id="admin-client">Admin Client</h2>
<p>It&rsquo;s also possible to figure out whether a consumer group exists, which offset it&rsquo;s reading from (per partition). Create a new notebook called <code>admin.ipynb</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="n">KafkaAdminClient</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;bootstrap_servers&#39;</span><span class="p">:</span> <span class="s1">&#39;localhost:29091&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;security_protocol&#39;</span><span class="p">:</span> <span class="s1">&#39;PLAINTEXT&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="n">KafkaAdminClient</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="p">)</span>
</span></span></code></pre></div><p>List the consumer groups:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">a</span><span class="o">.</span><span class="n">list_consumer_groups</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="p">[(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;consumer&#39;</span><span class="p">)]</span>  <span class="c1"># consumer group &#39;test&#39; which is a &#39;consumer&#39;</span>
</span></span></code></pre></div><p>You could decide to read from the first available offset (depending on the topic retention period) if the consumer group is new:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># check whether &#39;test&#39; is not a key of {&#39;test&#39;: &#39;consumer&#39;}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># which means that no such consumer group exists</span>
</span></span><span class="line"><span class="cl"><span class="n">start_at_beginning</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">list_consumer_groups</span><span class="p">())</span>
</span></span></code></pre></div><p>When the consumer group has been used, you can see which offset it is at:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">a</span><span class="o">.</span><span class="n">list_consumer_group_offsets</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="p">{</span><span class="n">TopicPartition</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">partition</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="n">OffsetAndMetadata</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)}</span>
</span></span></code></pre></div><h2 id="committing-offsets">Committing Offsets</h2>
<p>When a message has been received, it is assumed that all previous messages have been processed. By default, the consumer commits the offset to the Kafka cluster.</p>
<p>How many times the offset is committed depends on the <code>auto_commit_interval_ms</code> property. So if the processed messages have not yet been committed, and the app crashes, it might occur that messages that have already been processed are processed once again (duplicates).</p>
<p>The alternative would be to disable auto commit <code>enable_auto_commit</code>, and do the committing yourself:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="n">TopicPartition</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">kafka.structs</span> <span class="kn">import</span> <span class="n">OffsetAndMetadata</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># we only have one partition</span>
</span></span><span class="line"><span class="cl"><span class="n">partition</span> <span class="o">=</span> <span class="n">TopicPartition</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">partition</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># the message is considered processed</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_offset</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># offset of next message the app should consume</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">commit_async</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="n">partition</span><span class="p">:</span> <span class="n">OffsetAndMetadata</span><span class="p">(</span><span class="n">next_offset</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">pass</span>
</span></span></code></pre></div><p>As you can see, we commit <a href="https://kafka-python.readthedocs.io/en/master/apidoc/KafkaConsumer.html#kafka.KafkaConsumer.commit">the next offset</a> rather than the current one.</p>
<h2 id="conclusion">Conclusion</h2>
<p>This article introduced key concepts for Kafka consumers and message processing. We covered handling offsets, reading messages from the start of a topic, creating and managing consumer groups, and manual message tracking. The provided example code offers a practical demonstration that can be expanded upon for larger applications. By grasping these concepts, you can enhance your Kafka consumer&rsquo;s efficiency and reliability in processing messages from topics.</p>

</div>

<div class="content">
  
  <span class="post-meta">
    
      <a href="/tags/kafka">#kafka</a>&nbsp;
    
      <a href="/tags/python">#python</a>&nbsp;
    
  </span>
  <br>
  <br>


  <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "menziess" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  

</div>


        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">

        <div class="employer">
  
  <a href="https://www.thenextgen.nl/contact?ref=https://menziess.github.io">
    <img src="/images/logo/thenextgen.svg" alt="thenextgen">
  </a>
</div>


        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://github.com/menziess/">github</a></li>
            <li class="zerostatic"><a href="https://www.linkedin.com/in/stefanschenk/">linkedin</a></li>
            <li class="zerostatic"><a href="https://paypal.me/menziess/">help me stay awake! ☕️</a></li>
            <li class="zerostatic">
              <a href="/images/logo/bitcoin-receive-address.jpg#bc1qvn6y4htrzqjsk9ncdgx4km73kes7khkqldesxy">
                <img src="/images/logo/bitcoin.png"
                     alt="Bitcoin"
                     width="20px"
                     style="padding-bottom: 2px">
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>


  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

</body>

</html>
