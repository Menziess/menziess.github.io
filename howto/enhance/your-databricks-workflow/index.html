<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Enhance Your Databricks Workflow - menziess blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,700|Lora:400,700|Fira+Code:300,400">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msvalidate.01" content="DF64D3472558D82FA059638FC476FF14">
  <meta name="msapplication-TileColor" content="#603cba">
  <meta name="theme-color" content="#ffffff">

  
  <script data-ad-client="ca-pub-8067316566231197" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


  
  
  
    
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-157518256-1"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-157518256-1');
      </script>
    
  

  
  
  <link rel="stylesheet" href="/css/style.min.f9914e35727660e7509c3288c2988addb8b47fae3590399138cccc8980a683a8.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-posts">
      <a href="/howto/">
        <span>Posts</span>
      </a>
    </li>
    
    <li class="menu-item-tags">
      <a href="/tags/">
        <span>Tags</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://menziess.github.io/howto"><img draggable="false" alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://menziess.github.io/howto"><img draggable="false" alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-posts">
      <a href="/howto/">
        <span>Posts</span>
      </a>
    </li>
    
    <li class="menu-item-tags">
      <a href="/tags/">
        <span>Tags</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <h4>Howto</h4>

  
  <ul>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/python-packages-on-azure-synapse/">Install Python Packages on Azure Synapse</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/python-packages-on-databricks/">Install Python Packages on Databricks</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/run/gui-apps-with-docker/">Run GUI Apps With Docker</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/run/databricks-notebooks-from-devops/">Run Databricks Notebooks from DevOps</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/parameterize/databricks-notebooks/">Parameterize Databricks Notebooks</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/use/functional-programming-in-python/">Use Functional Programming In Python</a>
    </li>
    
    <li class="active ">
      <a href="https://menziess.github.io/howto/enhance/your-databricks-workflow/">Enhance Your Databricks Workflow</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/create/python-packages/">Create Python Packages</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/enhance/your-python-vscode-workflow/">Enhance Your Python-vscode Workflow</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/databricks-connect/">Install databricks-connect</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/windows-subsystem-for-linux/">Install Windows Subsystem for Linux</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/test/python-code/">Test Python Code</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/test/code-in-databricks-notebooks/">Test Code in Databricks Notebooks</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/manage/virtual-environments/">Manage Virtual Environments</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/manage/python-versions/">Manage Python Versions</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/create/a-blog/">Create a Blog</a>
    </li>
    
  </ul>
  

</div>

          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Enhance Your Databricks Workflow</h1>
<div class="pb-2 content anchor-link-enabled">
  <p>With databricks-connect you can connect your favorite IDE to your Databricks cluster. This means that you can now <strong>lint</strong>, <strong>test</strong>, and <strong>package</strong> the code that you want to run on Databricks more easily:</p>
<p><img src="/images/enhance-your-databricks-workflow/databricks-connect.png" alt=""></p>
<p>By applying ci-cd practices you can <strong>continuously deliver</strong> and install versioned packages of your python code on your Databricks cluster:</p>
<p><img src="/images/enhance-your-databricks-workflow/databricks-workflow.png" alt=""></p>
<p>All you need is <code>vscode</code>, a <code>databricks workspace</code>, a <code>storage account</code>, and <code>data factory</code> to follow along with this post.</p>
<h2 id="topics">Topics</h2>
<ol>
<li><a href="#1-local-setup">Local Setup</a></li>
<li><a href="#2-remote-setup">Remote Setup</a></li>
<li><a href="#3-package-the-spark-app">Package the Spark App</a></li>
<li><a href="#4-test-the-spark-app">Test the Spark App</a></li>
<li><a href="#5-build-the-artifact">Build the Artifact</a></li>
<li><a href="#6-copy-the-package-to-dbfs">Copy the Package to DBFS</a></li>
<li><a href="#7-run-the-package-on-databricks-using-data-factory">Run the Package on Databricks Using Data Factory</a></li>
</ol>
<h2 id="1-local-setup">1. Local Setup</h2>
<p><img src="/images/logo/vscode.png#logo" alt=""> ‚ü∂ <img src="/images/logo/python.png#logo" alt=""></p>
<p>Let&rsquo;s create a small example spark app.</p>
<p>Create a project folder <code>demo-project</code> and install pyspark inside a new <a href="https://menziess.github.io/howto/manage/virtual-environments/">virtual environment</a>:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">mkdir demo-project <span class="o">&amp;&amp;</span> <span class="nb">cd</span> demo-project
pipenv install pyspark --python 3.
pipenv shell
</code></pre></div><p>Create a sample data file <code>mnt/demo/sampledata.csv</code> containing:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">id, firstname, lastname
1, Stefan, Schenk
</code></pre></div><p>Create a python file <code>src/demo/main.py</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">sf</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Read in data, add a column `added_column`.&#34;&#34;&#34;</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">spark</span><span class="o">.</span><span class="n">read</span>
        <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;inferSchema&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;added_column&#39;</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">main</span><span class="p">(</span><span class="s1">&#39;mnt/demo/*.csv&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div><p>Run the script to see if it works:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">‚ûú python src/demo/main.py üêåüö¨üòÅü§¶‚Äç‚ôÇÔ∏è
+---+----------+----------+------------+
<span class="p">|</span> id<span class="p">|</span> firstname<span class="p">|</span>  lastname<span class="p">|</span>added_column<span class="p">|</span>
+---+----------+----------+------------+
<span class="p">|</span>  1<span class="p">|</span>    Stefan<span class="p">|</span>    Schenk<span class="p">|</span>   üêåüö¨üòÅü§¶‚Äç‚ôÇÔ∏è<span class="p">|</span>
+---+----------+----------+------------+
</code></pre></div><p>It&rsquo;s quite basic, but it&rsquo;s good to start small.</p>
<h2 id="2-remote-setup">2. Remote Setup</h2>
<p><img src="/images/logo/python.png#logo" alt=""> ‚ü∂ <img src="/images/logo/databricks.png#logo" alt=""></p>
<p>From here on, we will make things more interesting.</p>
<ol>
<li>
<p>Install <a href="https://menziess.github.io/howto/install/databricks-connect/">databricks-connect</a> in your virtual environment.</p>
</li>
<li>
<p>Create a new blob container in your storage account named <code>demo</code>, and upload the <code>mnt/demo/sampledata.csv</code> file.</p>
</li>
<li>
<p>Use this utility <a href="https://gist.github.com/Menziess/e2fe3708e74e14885d83e9bd56cd5284#file-create_databricks_mount-py">notebook</a> to mount the demo container in your databricks workspace.</p>
</li>
<li>
<p>Run the following code in a notebook cell to see if you can list the data file:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">%fs ls mnt/demo
</code></pre></div></li>
</ol>
<p>Run your python script again (this time it should run on Databricks):</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt">‚ûú python src/demo/main.py üêåüö¨üòÅüôã
20/02/26 23:49:32 WARN Utils: Your hostname, ANL-SS14 resolves to a loopback address: 127.0.1.1; using 172.17.160.1 instead (on interface eth1)
20/02/26 23:49:32 WARN Utils: Set SPARK_LOCAL_IP if you need to bind to another address
20/02/26 23:49:33 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable
Using Spark&#39;s default log4j profile: org/apache/spark/log4j-defaults.properties
Setting default log level to &#34;WARN&#34;.
To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).
20/02/26 23:49:35 WARN MetricsSystem: Using default name SparkStatusTracker for source because neither spark.metrics.namespace nor spark.app.id is set.
View job details at https://westeurope.azuredatabricks.net/?o=3892784943666666#/setting/clusters/0214-195926-aptin821/sparkUi
+---+----------+----------+------------+
| id| firstname|  lastname|added_column|
+---+----------+----------+------------+
|  1|    Stefan|    Schenk|   üêåüö¨üòÅüôã|
+---+----------+----------+------------+
</code></pre></div><p>Cool, we just ran the same code on data in the cloud, using a powerful cluster.</p>
<p>Switch back to using regular <code>pyspark</code>, so we can swiftly develop locally.</p>
<h2 id="3-package-the-spark-app">3. Package the Spark App</h2>
<p><img src="/images/logo/python.png#logo#s" alt=""> ‚ü∂ <img src="/images/logo/devops.png#logo" alt=""></p>
<p>Our next step is to make our python code packageable, so that we can easily install and run it somewhere else.</p>
<ol>
<li>
<p>Create an empty <code>__init__.py</code> file in your <code>src/demo/</code> folder.</p>
</li>
<li>
<p>Create a <code>setup.py</code> file in your root directory:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="s2">&#34;&#34;&#34;Setup.py script for packaging project.&#34;&#34;&#34;</span>

<span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">read_pipenv_dependencies</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Get default dependencies from Pipfile.lock.&#34;&#34;&#34;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">lockfile</span><span class="p">:</span>
        <span class="n">lockjson</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">lockfile</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">dependency</span> <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">lockjson</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)]</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">setup</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PACKAGE_VERSION&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.dev0&#39;</span><span class="p">),</span>
        <span class="n">package_dir</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="s1">&#39;src&#39;</span><span class="p">},</span>
        <span class="n">packages</span><span class="o">=</span><span class="n">find_packages</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;demo*&#39;</span>
        <span class="p">]),</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A demo package.&#39;</span><span class="p">,</span>
        <span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
            <span class="o">*</span><span class="n">read_pipenv_dependencies</span><span class="p">(</span><span class="s1">&#39;Pipfile.lock&#39;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div><p>Read more about these <code>__init__.py</code> and <code>setup.py</code> scripts <a href="https://menziess.github.io/howto/create/python-packages/#1-packaging-setup">here</a>.</p>
</li>
<li>
<p>Install your code as an &ldquo;editable&rdquo; package in your virtual environment:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">pip install -e .
</code></pre></div><p>This means that whenever you edit your python files, the installed package will include the changes, making development easier.</p>
<p>You will now be able to import from your package:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">‚ûú python
Python 3.7.5 <span class="o">(</span>default, Dec  <span class="m">3</span> 2019, 12:09:43<span class="o">)</span>
<span class="o">[</span>GCC 7.4.0<span class="o">]</span> on linux
Type <span class="s2">&#34;help&#34;</span>, <span class="s2">&#34;copyright&#34;</span>, <span class="s2">&#34;credits&#34;</span> or <span class="s2">&#34;license&#34;</span> <span class="k">for</span> more information.
&gt;&gt;&gt; from demo.main import main
&gt;&gt;&gt; main
&lt;<span class="k">function</span> main at 0x7f086af5cc20&gt;
</code></pre></div></li>
<li>
<p>Build a distributable wheel &ndash; using the same script &ndash; by running:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">python setup.py bdist_wheel
</code></pre></div><p>A <code>dist/</code> folder will have appeared, containing the <code>.whl</code> distribution.</p>
</li>
</ol>
<p>We will utilize this packaging capability in our build pipeline, to create a new artifact whenever we push new changes to the repository.</p>
<h2 id="4-test-the-spark-app">4. Test the Spark App</h2>
<p><img src="/images/logo/testing.png#logo" alt=""></p>
<p>But before we build anything, we want to make sure that our code-style is acceptable, and that new changes have not broken any existing code. Testing should be part of your databricks workflow.</p>
<ol>
<li>
<p>Create a new python file <code>tests/demo/test_main.py</code> containing the following code:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="s2">&#34;&#34;&#34;Test main module.&#34;&#34;&#34;</span>

<span class="kn">from</span> <span class="nn">python_package.main</span> <span class="kn">import</span> <span class="n">main</span>


<span class="k">def</span> <span class="nf">test_main</span><span class="p">():</span>
    <span class="s2">&#34;&#34;&#34;Test whether main function works.&#34;&#34;&#34;</span>
    <span class="n">expected_value</span> <span class="o">=</span> <span class="s1">&#39;üëçü§ûüëåüêå&#39;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span>
        <span class="n">row</span><span class="o">.</span><span class="n">added_column</span> <span class="o">==</span> <span class="n">expected_value</span>
        <span class="k">for</span> <span class="n">row</span>
        <span class="ow">in</span> <span class="p">(</span>
            <span class="n">main</span><span class="p">(</span><span class="s1">&#39;mnt/demo/*.csv&#39;</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;added_column&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">])</span>
</code></pre></div></li>
<li>
<p>Run the test:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">pytest
</code></pre></div></li>
</ol>
<p>By running the test we have verified that every single row had the value <code>üëçü§ûüëåüêå</code> in the column called <code>added_column</code>. If someone accidentally modified the code, the tests (that we will run in our build pipeline) will fail, ensuring that the broken code never reaches production.</p>
<p>You would also be able to add something called <code>doctests</code> to your functions as examples for fellow developers who make use of your functions (<a href="https://menziess.github.io/howto/test/python-code/#doctests">example</a>).</p>
<p>In addition to tests, you should make sure that the code style is acceptable by running a linter over your code.</p>
<ol>
<li>
<p>Install the python vscode extension, and set up <code>mypy</code> and <code>flake8</code> for <code>vscode</code> to highlight code-style issues (<a href="https://menziess.github.io/howto/enhance/your-python-vscode-workflow/#testing-and-linting">example</a>).</p>
</li>
<li>
<p>Run the following commands to analyze your code:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">mypy src --ignore-missing-imports
flake8 src
</code></pre></div><p>We will also run these commands in our build pipeline, any errors will cause the pipeline to fail until the code has been cleaned up again.</p>
</li>
</ol>
<p>Everything seems ready to be shipped to production.</p>
<h2 id="5-build-the-artifact">5. Build the Artifact</h2>
<p><img src="/images/logo/artifact.png#logo" alt=""></p>
<p>We will now start applying ci-cd practices to continuously release our code onto Databricks (continuous delivery / continuous deployment).</p>
<p>We&rsquo;ll automate the process of testing and building our final package by using an Azure DevOps pipeline (<a href="https://menziess.github.io/howto/create/python-packages/#7-devops">example</a>).</p>
<p>Create a file <code>azure-pipelines.yml</code> in your root directory:</p>
<div class="highlight"><pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">repo</span><span class="p">:</span><span class="w"> </span>self<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">trigger</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- master<span class="w">
</span><span class="w">  </span>- refs/tags/v*<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">variables</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">python.version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span><span class="w">  </span><span class="k">major_minor</span><span class="p">:</span><span class="w"> </span>$<span class="p">[</span>format(<span class="s1">&#39;{0:yy}.{0:MM}&#39;</span><span class="p">,</span><span class="w"> </span>pipeline.startTime)<span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="k">counter_unique_key</span><span class="p">:</span><span class="w"> </span>$<span class="p">[</span>format(<span class="s1">&#39;{0}.demo&#39;</span><span class="p">,</span><span class="w"> </span>variables.major_minor)<span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="k">patch</span><span class="p">:</span><span class="w"> </span>$<span class="p">[</span>counter(variables.counter_unique_key<span class="p">,</span><span class="w"> </span><span class="m">0</span>)<span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="k">fallback_tag</span><span class="p">:</span><span class="w"> </span>$(major_minor).dev$(patch)<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">stages</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">stage</span><span class="p">:</span><span class="w"> </span>Test<span class="w">
</span><span class="w">    </span><span class="k">jobs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">job</span><span class="p">:</span><span class="w"> </span>Test<span class="w">
</span><span class="w">        </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Test<span class="w">
</span><span class="w">        </span><span class="k">steps</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="k">task</span><span class="p">:</span><span class="w"> </span>UsePythonVersion@<span class="m">0</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Use Python $(python.version)&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">versionSpec</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;$(python.version)&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pipenv<span class="w"> </span><span class="cp">&amp;&amp;</span><span class="w"> </span>pipenv<span class="w"> </span>install<span class="w"> </span>-d<span class="w"> </span>--system<span class="w"> </span>--deploy<span class="w"> </span>--ignore-pipfile<span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Install dependencies&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>typed_ast<span class="w"> </span><span class="cp">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>lint<span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Lint<span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pathlib2<span class="w"> </span><span class="cp">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>test<span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Test<span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">task</span><span class="p">:</span><span class="w"> </span>PublishTestResults@<span class="m">2</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Publish Test Results junit/*&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">condition</span><span class="p">:</span><span class="w"> </span>always()<span class="w">
</span><span class="w">            </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">testResultsFiles</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;junit/*&#34;</span><span class="w">
</span><span class="w">              </span><span class="k">testRunTitle</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Python $(python.version)&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="k">stage</span><span class="p">:</span><span class="w"> </span>Build<span class="w">
</span><span class="w">    </span><span class="k">dependsOn</span><span class="p">:</span><span class="w"> </span>Test<span class="w">
</span><span class="w">    </span><span class="k">jobs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">job</span><span class="p">:</span><span class="w"> </span>Build<span class="w">
</span><span class="w">        </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Build<span class="w">
</span><span class="w">        </span><span class="k">steps</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="k">task</span><span class="p">:</span><span class="w"> </span>UsePythonVersion@<span class="m">0</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Use Python $(python.version)&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">versionSpec</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;$(python.version)&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pip install wheel&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Wheel&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">              # Get version from git tag (v1.0.0) -&gt; (1.0.0)</span><span class="w">
</span><span class="w">              </span>git_tag=`git<span class="w"> </span>describe<span class="w"> </span>--abbrev=<span class="m">0</span><span class="w"> </span>--tags<span class="w"> </span>|<span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39;v&#39;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">2</span>`<span class="w">
</span><span class="w">              </span>echo<span class="w"> </span><span class="s2">&#34;##vso[task.setvariable variable=git_tag]$git_tag&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Set<span class="w"> </span>GIT_TAG<span class="w"> </span>variable<span class="w"> </span>if<span class="w"> </span>tag<span class="w"> </span>is<span class="w"> </span>pushed<span class="w">
</span><span class="w">            </span><span class="k">condition</span><span class="p">:</span><span class="w"> </span>contains(variables<span class="p">[</span><span class="s1">&#39;Build.SourceBranch&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;refs/tags/v&#39;</span>)<span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">              # Get variables that are shared across jobs</span><span class="w">
</span><span class="w">              </span>GIT_TAG=$(git_tag)<span class="w">
</span><span class="w">              </span>FALLBACK_TAG=$(fallback_tag)<span class="w">
</span><span class="w">              </span><span class="k">echo GIT TAG: $GIT_TAG, FALLBACK_TAG</span><span class="p">:</span><span class="w"> </span>$FALLBACK_TAG<span class="w">
</span><span class="w">
</span><span class="w">              </span><span class="c"># Export variable so python can access it</span><span class="w">
</span><span class="w">              </span>export<span class="w"> </span>PACKAGE_VERSION=${GIT_TAG<span class="p">:</span>-${FALLBACK_TAG<span class="p">:</span>-default}}<span class="w">
</span><span class="w">              </span><span class="k">echo Version used in setup.py</span><span class="p">:</span><span class="w"> </span>$PACKAGE_VERSION<span class="w">
</span><span class="w">
</span><span class="w">              </span><span class="c"># Use PACKAGE_VERSION in setup()</span><span class="w">
</span><span class="w">              </span>python<span class="w"> </span>setup.py<span class="w"> </span>bdist_wheel<span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Build<span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">task</span><span class="p">:</span><span class="w"> </span>CopyFiles@<span class="m">2</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Copy<span class="w"> </span>dist<span class="w"> </span>files<span class="w">
</span><span class="w">            </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">sourceFolder</span><span class="p">:</span><span class="w"> </span>dist/<span class="w">
</span><span class="w">              </span><span class="k">contents</span><span class="p">:</span><span class="w"> </span>demo<span class="cp">*.whl</span><span class="w">
</span><span class="w">              </span><span class="k">targetFolder</span><span class="p">:</span><span class="w"> </span>$(Build.ArtifactStagingDirectory)<span class="w">
</span><span class="w">              </span><span class="k">flattenFolders</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">task</span><span class="p">:</span><span class="w"> </span>PublishBuildArtifacts@<span class="m">1</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>PublishArtifact<span class="w">
</span><span class="w">            </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">pathtoPublish</span><span class="p">:</span><span class="w"> </span>$(Build.ArtifactStagingDirectory)<span class="w">
</span><span class="w">              </span><span class="k">ArtifactName</span><span class="p">:</span><span class="w"> </span>demo.whl<span class="w">
</span></code></pre></div><p>When you scan through the file, you&rsquo;ll see some commands that are called using a <code>Makefile</code>, add this file to your root directory:</p>
<div class="highlight"><pre class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="nf">lint</span><span class="o">:</span>
	mypy src --ignore-missing-imports
	flake8 src --ignore<span class="o">=</span><span class="k">$(</span>shell cat .flakeignore<span class="k">)</span>

<span class="nf">dev</span><span class="o">:</span>
	pip install -e .

<span class="nf">test</span><span class="o">:</span> <span class="n">dev</span>
	pytest --doctest-modules --junitxml<span class="o">=</span>junit/test-results.xml
	bandit -r src -f xml -o junit/security.xml <span class="o">||</span> <span class="nb">true</span>
</code></pre></div><p>Create a new repository <a href="https://dev.azure.com/">here</a>, then commit and push your code.</p>
<p>In Azure DevOps create a new build pipeline, select your <code>azure-pipelines.yml</code> file, and click &ldquo;Run&rdquo;. If everything goes well, an artifact will be created:</p>
<p><img src="/images/enhance-your-databricks-workflow/build-succeeded.png#large" alt=""></p>
<h2 id="6-copy-the-package-to-dbfs">6. Copy the Package to DBFS</h2>
<p><img src="/images/logo/releases.png#logo" alt=""> ‚ü∂ <img src="/images/logo/databricks.png#logo" alt=""></p>
<p>Next, create a new release pipeline in Azure DevOps. Choose to start with an &ldquo;Empty job&rdquo;.</p>
<ol>
<li>
<p>In the artifacts section, add your demo build.</p>
</li>
<li>
<p>Click on the small bolt icon, and enable continuous-deployments. As a filter include the <code>master</code> branch.</p>
<p><img src="/images/enhance-your-databricks-workflow/cd.png#large#shadow" alt=""></p>
</li>
<li>
<p>In the first stage, add a new task by searching for &ldquo;Databricks files to DBFS&rdquo;, you may have to install this task from the marketplace. Enter the following values:</p>
<p><img src="/images/enhance-your-databricks-workflow/stage.png#large#shadow" alt=""></p>
</li>
<li>
<p>Finally, create a new Databricks token, and add it to a variable in your release pipeline:</p>
<p><img src="/images/enhance-your-databricks-workflow/token.png#large#shadow" alt=""></p>
</li>
<li>
<p>Trigger the release pipeline, and take a look inside your <code>/libraries</code> folder on DBFS, you should see your package there:</p>
<p><img src="/images/enhance-your-databricks-workflow/dbfs.png#medium#shadow" alt=""></p>
</li>
</ol>
<p>Whenever the package has successfully been built, this release is triggered, which will copy the artifact to DBFS, where Databricks notebooks will be able to pick it up and install it.</p>
<h2 id="7-run-the-package-on-databricks-using-data-factory">7. Run the Package on Databricks Using Data Factory</h2>
<p><img src="/images/logo/databricks.png#logo" alt=""> ‚üµ <img src="/images/logo/datafactory.png#logo" alt=""></p>
<p>As our orchestration tool, we&rsquo;ll use Data Factory. We&rsquo;ll be able to pass the dependencies and arguments to our Databricks notebook, which then runs our package.</p>
<ol>
<li>
<p>Create a &ldquo;runner&rdquo; notebook that takes two arguments: <code>filepath</code> and <code>value</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Databricks notebook source</span>
<span class="c1"># MAGIC %md # Runner</span>

<span class="c1"># COMMAND ----------</span>

<span class="n">dbutils</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s1">&#39;filepath&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">filepath</span> <span class="o">=</span> <span class="n">dbutils</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filepath&#39;</span><span class="p">)</span>

<span class="c1"># COMMAND ----------</span>

<span class="n">dbutils</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">dbutils</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>

<span class="c1"># COMMAND ----------</span>

<span class="kn">from</span> <span class="nn">demo.main</span> <span class="kn">import</span> <span class="n">main</span>

<span class="n">main</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></li>
<li>
<p>In Data Factory, create a new &ldquo;compute&rdquo; Databricks Linked Service:</p>
<p><img src="/images/enhance-your-databricks-workflow/linked-service.png#large#shadow" alt=""></p>
</li>
<li>
<p>Create a new pipeline, and add a Databricks activity. Add the path to your package as a <code>wheel</code> library, and provide the required arguments:</p>
<p><img src="/images/enhance-your-databricks-workflow/pipeline.png#shadow" alt=""></p>
</li>
<li>
<p>Press &ldquo;Debug&rdquo;, and hover over the job run in the Output tab. Then click on the glasses icon, and click on the link that takes you to the Databricks job run.</p>
<p><img src="/images/enhance-your-databricks-workflow/result.png#large#shadow" alt=""></p>
</li>
</ol>
<p>And that&rsquo;s it! Let me hear your feedback in the comments below üòÉüëçüêåüéà.</p>

</div>

<div class="content">
  
  <span class="post-meta">
    
      <a href="/tags/databricks">#databricks</a>&nbsp;
    
      <a href="/tags/databricks-connect">#databricks-connect</a>&nbsp;
    
      <a href="/tags/packaging">#packaging</a>&nbsp;
    
      <a href="/tags/testing">#testing</a>&nbsp;
    
      <a href="/tags/devops">#devops</a>&nbsp;
    
      <a href="/tags/workflow">#workflow</a>&nbsp;
    
      <a href="/tags/data-factory">#data factory</a>&nbsp;
    
  </span>
  <br>
  <br>


  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <ins class="adsbygoogle"
       style="display:block; text-align:center;"
       data-ad-layout="in-article"
       data-ad-format="fluid"
       data-ad-client="ca-pub-8067316566231197"
       data-ad-slot="6727241056"></ins>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({});
  </script>


  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "menziess" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  

</div>


        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://github.com/menziess/">github</a></li>
            <li class="zerostatic"><a href="https://www.linkedin.com/in/stefanschenk/">linkedin</a></li>
            <li class="zerostatic"><a href="https://paypal.me/menziess/">help me stay awake! ‚òïÔ∏è</a></li>
            <li class="zerostatic">
              <a href="/images/logo/bitcoin-receive-address.jpg#bc1qqpxhyd8fxxk0aay2aamvae7msp3a5dgnjj9vrw">
                <img src="/images/logo/bitcoin.png"
                     alt="Bitcoin"
                     width="20px"
                     style="padding-bottom: 2px">
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>


  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

</body>

</html>
