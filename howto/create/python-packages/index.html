<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create Python Packages - menziess blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,700|Lora:400,700|Fira+Code:300,400">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msvalidate.01" content="DF64D3472558D82FA059638FC476FF14">
  <meta name="msapplication-TileColor" content="#603cba">
  <meta name="theme-color" content="#ffffff">

  
  
  
    
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-157518256-1"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-157518256-1');
      </script>
    
  

  
  
  <link rel="stylesheet" href="/css/style.min.5ce3a64371a6d6ad4ae139017128b33f631277a6aa4b592c44b2ce53ca68e5e3.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-posts">
      <a href="/howto/">
        <span>Posts</span>
      </a>
    </li>
    
    <li class="menu-item-tags">
      <a href="/tags/">
        <span>Tags</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://menziess.github.io/howto"><img draggable="false" alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://menziess.github.io/howto"><img draggable="false" alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-posts">
      <a href="/howto/">
        <span>Posts</span>
      </a>
    </li>
    
    <li class="menu-item-tags">
      <a href="/tags/">
        <span>Tags</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <h4>Howto</h4>

  
  <ul>
    
    <li class="">
      <a href="https://menziess.github.io/howto/manage/kafka-streams/">Manage Kafka Streams</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/create/python-executables/">Create Python Executables</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/use/key-vault-secrets-in-data-factory/">Use Key Vault Secrets In Data Factory</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/python-packages-from-azure-devops/">Install Python Packages From Azure DevOps</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/python-packages-on-azure-synapse/">Install Python Packages on Azure Synapse</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/python-packages-on-databricks/">Install Python Packages on Databricks</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/run/gui-apps-with-docker/">Run GUI Apps With Docker</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/run/databricks-notebooks-from-devops/">Run Databricks Notebooks from DevOps</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/parameterize/databricks-notebooks/">Parameterize Databricks Notebooks</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/use/functional-programming-in-python/">Use Functional Programming In Python</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/enhance/your-databricks-workflow/">Enhance Your Databricks Workflow</a>
    </li>
    
    <li class="active ">
      <a href="https://menziess.github.io/howto/create/python-packages/">Create Python Packages</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/enhance/your-python-vscode-workflow/">Enhance Your Python-vscode Workflow</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/databricks-connect/">Install databricks-connect</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/windows-subsystem-for-linux/">Install Windows Subsystem for Linux</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/test/python-code/">Test Python Code</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/test/code-in-databricks-notebooks/">Test Code in Databricks Notebooks</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/manage/virtual-environments/">Manage Virtual Environments</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/manage/python-versions/">Manage Python Versions</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/create/a-blog/">Create a Blog</a>
    </li>
    
  </ul>
  

</div>

          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Create Python Packages</h1>
<div class="pb-2 content anchor-link-enabled">
  <p>Why should you care about creating packages?</p>
<ul>
<li>packages are easy to install (<code>pip install demo</code>).</li>
<li>packages simplify development (<code>pip install -e .</code> installs your package and keeps it up-to-date during development).</li>
<li>packages are easy to run and test (<code>from demo.main import say_hello</code>, then test the function).</li>
<li>packages are easy to version, avoiding breaking dependant&rsquo;s code (<code>pip install demo==1.0.3</code>).</li>
</ul>
<p>Library vs Package vs Module:</p>
<ul>
<li><strong>Module</strong>: a <code>.py</code> file containing functions that belong together</li>
<li><strong>Package</strong>: a collection of modules that is distributable</li>
<li><strong>Library</strong>: a package that is a not context aware</li>
</ul>
<p><img src="/images/logo/artifact.png#logo" alt=""></p>
<p>Packaging python code is quite easy, you require a single <code>setup.py</code> script to package in several distribution formats.</p>
<h2 id="topics">Topics</h2>
<ol>
<li><a href="#1-packaging-setup">Packaging Setup</a></li>
<li><a href="#2-documentation">Documentation</a></li>
<li><a href="#3-linting-and-testing">Linting and Testing</a></li>
<li><a href="#4-makefile">Makefile</a></li>
<li><a href="#5-installing-wheel">Installing wheel</a></li>
<li><a href="#6-include-config-files">Include Config Files</a></li>
<li><a href="#7-devops">DevOps</a></li>
</ol>
<h2 id="1-packaging-setup">1. Packaging Setup</h2>
<p>Let&rsquo;s use the folder structure from an <a href="https://menziess.github.io/howto/test/python-code/">earlier post</a>, and create a <a href="https://menziess.github.io/howto/manage/virtual-environments/">virtual environment</a> in it:</p>
<p><a href="https://github.com/Menziess/python-packaging/tree/barebones"><img src="https://img.shields.io/badge/demo-barebones-green" alt="github"></a>
<a href="https://replit.com/@Menziess/barebones"><img src="https://repl.it/badge/github/menziess/barebones" alt="Run on Repl.it"></a></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">➜ tree -a -L <span class="m">2</span>
.
├── .venv
│   └── ...
├── Pipfile
├── Pipfile.lock
├── src
│   └── demo
│       └── main.py
└── tests
    └── demo
        └── ...

<span class="m">9</span> directories, <span class="m">3</span> files
</code></pre></div><p>Create a <code>setup.py</code> file in the root directory that we will use to define the way we&rsquo;d like to package our code, containing the following code:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="s2">&#34;&#34;&#34;Setup.py script for packaging project.&#34;&#34;&#34;</span>

<span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">read_pipenv_dependencies</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Get default dependencies from Pipfile.lock.&#34;&#34;&#34;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">lockfile</span><span class="p">:</span>
        <span class="n">lockjson</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">lockfile</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">dependency</span> <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">lockjson</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)]</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">setup</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PACKAGE_VERSION&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.dev0&#39;</span><span class="p">),</span>
        <span class="n">package_dir</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="s1">&#39;src&#39;</span><span class="p">},</span>
        <span class="n">packages</span><span class="o">=</span><span class="n">find_packages</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;demo*&#39;</span>
        <span class="p">]),</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A demo package.&#39;</span><span class="p">,</span>
        <span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
            <span class="o">*</span><span class="n">read_pipenv_dependencies</span><span class="p">(</span><span class="s1">&#39;Pipfile.lock&#39;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div><p>You can now call this script to package your code in several ways:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">python setup.py develop <span class="c1"># don&#39;t generate anything, just install locally</span>
python setup.py bdist_egg <span class="c1"># generate egg distribution, doesn&#39;t include dependencies</span>
python setup.py bdist_wheel <span class="c1"># generate versioned wheel, includes dependencies</span>
python setup.py sdist --formats<span class="o">=</span>zip,gztar,bztar,ztar,tar <span class="c1"># source code</span>
</code></pre></div><p>Run the first one in the list above. When it succeeds, you will be able to import your code as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">demo.main</span> <span class="kn">import</span> <span class="n">say_hello</span>
</code></pre></div><blockquote>
<p><strong>Note:</strong> if you are receiving &ldquo;No module named demo&hellip;&quot;, you&rsquo;ll need to add an empty <code>__init__.py</code> file in all folders you want to import from. In our example, that only includes the <code>demo</code> folder. You can read more about these <code>__init__.py</code> files <a href="https://docs.python.org/3/reference/import.html#regular-packages">here</a>.</p>
</blockquote>
<p>Now that we were able to install the project, we should take a closer look at the arguments that we pass to the <code>setuptools.setup</code> function:</p>
<ol>
<li><code>name</code>: the name of your package</li>
<li><code>version</code>: every change to your code should yield a different package version, or else developers may install the same package version that&rsquo;s suddenly behaving differently, breaking their code</li>
<li><code>packages</code>: a list of paths of all your python files</li>
<li><code>install_requires</code>: a list of package names and versions (just as in a <code>requirements.txt</code> file)</li>
</ol>
<p>You can see that I wrote a simple function <code>read_pipenv_dependencies</code> to read the non-dev dependencies from the <code>Pipfile.lock</code>. Now I won&rsquo;t have to specify dependencies manually. I also use <code>os.getenv</code> to read in an environment variable to determine the package version, which are nice sagues to the next topics.</p>
<h2 id="2-documentation">2. Documentation</h2>
<p>Just as I read in the <code>Pipfile.lock</code> to specify my dependencies, I can also read in a <code>README.md</code> file to display useful documentation as the <code>long_description</code>. More information about this can be read on <a href="https://packaging.python.org/guides/making-a-pypi-friendly-readme/">packaging.python.org</a>.</p>
<p>In addition you can create a proper documentation web page using <code>readthedocs</code> and <code>shinx</code>. Create a folder for your documentation:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">mkdir docs
</code></pre></div><p>Install sphinx:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">pipenv install -d sphinx
</code></pre></div><p>Run the quickstart to generate the source directory for your documentation:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">sphinx-quickstart
</code></pre></div><p>Now you can start populating the <code>docs/index.rst</code> file with your documentation. Learn more about automating this process on <a href="https://www.sphinx-doc.org/en/master/usage/quickstart.html">sphinx-doc.org</a>.</p>
<h2 id="3-linting-and-testing">3. Linting and Testing</h2>
<p>As part of your packaging process, you&rsquo;d want to apply some static code analyses, linting, and testing.</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">pipenv install -d mypy autopep8 <span class="se">\
</span><span class="se"></span>  flake8 pytest bandit pydocstyle
</code></pre></div><p>Preferably, you&rsquo;d run a command to verify the code style, run some tests and checks before you push your commits to the remote repository, and cause a build pipeline to fail if the tests don&rsquo;t pass.</p>
<h2 id="4-makefile">4. Makefile</h2>
<p>As we&rsquo;re rapidly introducing new commands that are part of packaging our specific project, it is useful to record common commands. Most build automation tools (such as Gradle or npm) provide this feature by default.</p>
<p>Make is a tool to organize code compilation, traditionally used in c-oriented projects. But it can be used to run any other command.</p>
<p>By default, when you run <code>make</code>, it executes the first command in the list, in the example below it will execute <code>make help</code> and print out the contents of the Makefile.</p>
<p>If we run <code>make test</code>, it will first run <code>make dev</code>, as it&rsquo;s stated as a dependency in the Makefile:</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">help</span><span class="o">:</span>
	@echo <span class="s2">&#34;Tasks in \033[1;32mdemo\033[0m:&#34;</span>
	@cat Makefile

<span class="nf">lint</span><span class="o">:</span>
	mypy src --ignore-missing-imports
	flake8 src --ignore<span class="o">=</span><span class="k">$(</span>shell cat .flakeignore<span class="k">)</span>

<span class="nf">dev</span><span class="o">:</span>
	pip install -e .

<span class="nf">test</span><span class="o">:</span> <span class="n">dev</span>
	pytest --doctest-modules --junitxml<span class="o">=</span>junit/test-results.xml
	bandit -r src -f xml -o junit/security.xml <span class="o">||</span> <span class="nb">true</span>

<span class="nf">build</span><span class="o">:</span> <span class="n">clean</span>
	pip install wheel
	python setup.py bdist_wheel

<span class="nf">clean</span><span class="o">:</span>
	@rm -rf .pytest_cache/ .mypy_cache/ junit/ build/ dist/
	@find . -not -path <span class="s1">&#39;./.venv*&#39;</span> -path <span class="s1">&#39;*/__pycache__*&#39;</span> -delete
	@find . -not -path <span class="s1">&#39;./.venv*&#39;</span> -path <span class="s1">&#39;*/*.egg-info*&#39;</span> -delete
</code></pre></div><p>Now, as you can see, it&rsquo;s quite easy for new developers to contribute to the project. They now have a nice overview of common commands, for example to build a wheel: <code>make build</code>.</p>
<h2 id="5-installing-wheel">5. Installing wheel</h2>
<p>When you run <code>make build</code>, it will use the <code>setup.py</code> file to create a wheel distribution. You&rsquo;ll find a <code>.whl</code> file in the <code>dist/</code> folder, having <code>0.0.dev0</code> in the name. You can now specify an environment variable to change the version of the wheel:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh"><span class="nb">export</span> <span class="nv">PACKAGE_VERSION</span><span class="o">=</span><span class="s1">&#39;1.0.0&#39;</span>
make build
ls dist
</code></pre></div><p>Having the wheel, you can create a new folder, somewhere on your desktop, copy the wheel into it, and install it using:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">mkdir test-whl <span class="o">&amp;&amp;</span> <span class="nb">cd</span> test-whl
pipenv shell
pip install *.whl
</code></pre></div><p>Print out the installed packages:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh">pip list
</code></pre></div><h2 id="6-include-config-files">6. Include Config Files</h2>
<p>It&rsquo;s also possible to add data to your package by adding the following lines to your <code>setup.py</code> script:</p>
<blockquote>
<p><strong>Note:</strong> This may not work on distributed systems (such as Databricks).</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">setup</span><span class="p">(</span>
        <span class="n">data_files</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;data/my-config.json&#39;</span><span class="p">])</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div><p>You&rsquo;ll then be able to read the file by using this function:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_cfg_file</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">foldername</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="s2">&#34;&#34;&#34;Get config file.
</span><span class="s2">
</span><span class="s2">    Using &#39;data_files&#39; property from setup.py script.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Foldername must be string.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">foldername</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Foldername must not start with </span><span class="se">\&#39;</span><span class="s1">/</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Filename must be string.&#39;</span><span class="p">)</span>

    <span class="c1"># Will first try to read file from installed location</span>
    <span class="c1"># this only applies for .whl installations</span>
    <span class="c1"># Otherwise it will read file directly</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">foldername</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">foldername</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div><p>If you create a wheel again, and install it in a virtual environment in a new folder, without copying the data file, you should be able to access the data by executing the function above.</p>
<h2 id="7-devops">7. DevOps</h2>
<p>As part of our packaging process, we want to integrate changes from many contributors, and automate as many repetitive processes that are required to successfully release a new version.</p>
<p>For this example we&rsquo;ll use Azure DevOps, where the following pipeline will be triggered on <code>git tags</code> as well as the <code>master</code> branch.</p>
<p>Have a look, and we&rsquo;ll discuss the various stages and tasks afterwards:</p>
<div class="highlight"><pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">repo</span><span class="p">:</span><span class="w"> </span>self<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">trigger</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- master<span class="w">
</span><span class="w">  </span>- refs/tags/v*<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">variables</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">python.version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span><span class="w">  </span><span class="k">project</span><span class="p">:</span><span class="w"> </span>demo<span class="w">
</span><span class="w">  </span><span class="k">feed</span><span class="p">:</span><span class="w"> </span>demo<span class="w">
</span><span class="w">  </span><span class="k">major_minor</span><span class="p">:</span><span class="w"> </span>$<span class="p">[</span>format(<span class="s1">&#39;{0:yy}.{0:MM}&#39;</span><span class="p">,</span><span class="w"> </span>pipeline.startTime)<span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="k">counter_unique_key</span><span class="p">:</span><span class="w"> </span>$<span class="p">[</span>format(<span class="s1">&#39;{0}.demo&#39;</span><span class="p">,</span><span class="w"> </span>variables.major_minor)<span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="k">patch</span><span class="p">:</span><span class="w"> </span>$<span class="p">[</span>counter(variables.counter_unique_key<span class="p">,</span><span class="w"> </span><span class="m">0</span>)<span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="k">fallback_tag</span><span class="p">:</span><span class="w"> </span>$(major_minor).dev$(patch)<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">stages</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">stage</span><span class="p">:</span><span class="w"> </span>Test<span class="w">
</span><span class="w">    </span><span class="k">jobs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">job</span><span class="p">:</span><span class="w"> </span>Test<span class="w">
</span><span class="w">        </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Test<span class="w">
</span><span class="w">        </span><span class="k">steps</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="k">task</span><span class="p">:</span><span class="w"> </span>UsePythonVersion@<span class="m">0</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Use Python $(python.version)&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">versionSpec</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;$(python.version)&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pipenv<span class="w"> </span><span class="cp">&amp;&amp;</span><span class="w"> </span>pipenv<span class="w"> </span>install<span class="w"> </span>-d<span class="w"> </span>--system<span class="w"> </span>--deploy<span class="w"> </span>--ignore-pipfile<span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Install dependencies&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>typed_ast<span class="w"> </span><span class="cp">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>lint<span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Lint<span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pathlib2<span class="w"> </span><span class="cp">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>test<span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Test<span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">task</span><span class="p">:</span><span class="w"> </span>PublishTestResults@<span class="m">2</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Publish Test Results junit/*&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">condition</span><span class="p">:</span><span class="w"> </span>always()<span class="w">
</span><span class="w">            </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">testResultsFiles</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;junit/*&#34;</span><span class="w">
</span><span class="w">              </span><span class="k">testRunTitle</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Python $(python.version)&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="k">stage</span><span class="p">:</span><span class="w"> </span>Build<span class="w">
</span><span class="w">    </span><span class="k">dependsOn</span><span class="p">:</span><span class="w"> </span>Test<span class="w">
</span><span class="w">    </span><span class="k">jobs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">job</span><span class="p">:</span><span class="w"> </span>Build<span class="w">
</span><span class="w">        </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Build<span class="w">
</span><span class="w">        </span><span class="k">steps</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="k">task</span><span class="p">:</span><span class="w"> </span>UsePythonVersion@<span class="m">0</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Use Python $(python.version)&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">versionSpec</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;$(python.version)&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pip install wheel twine&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Wheel and Twine&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">              # Get version from git tag (v1.0.0) -&gt; (1.0.0)</span><span class="w">
</span><span class="w">              </span>git_tag=`git<span class="w"> </span>describe<span class="w"> </span>--abbrev=<span class="m">0</span><span class="w"> </span>--tags<span class="w"> </span>|<span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39;v&#39;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">2</span>`<span class="w">
</span><span class="w">              </span>echo<span class="w"> </span><span class="s2">&#34;##vso[task.setvariable variable=git_tag]$git_tag&#34;</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Set<span class="w"> </span>GIT_TAG<span class="w"> </span>variable<span class="w"> </span>if<span class="w"> </span>tag<span class="w"> </span>is<span class="w"> </span>pushed<span class="w">
</span><span class="w">            </span><span class="k">condition</span><span class="p">:</span><span class="w"> </span>contains(variables<span class="p">[</span><span class="s1">&#39;Build.SourceBranch&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;refs/tags/v&#39;</span>)<span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">              # Get variables that are shared across jobs</span><span class="w">
</span><span class="w">              </span>GIT_TAG=$(git_tag)<span class="w">
</span><span class="w">              </span>FALLBACK_TAG=$(fallback_tag)<span class="w">
</span><span class="w">              </span><span class="k">echo GIT TAG: $GIT_TAG, FALLBACK_TAG</span><span class="p">:</span><span class="w"> </span>$FALLBACK_TAG<span class="w">
</span><span class="w">
</span><span class="w">              </span><span class="c"># Export variable so python can access it</span><span class="w">
</span><span class="w">              </span>export<span class="w"> </span>PACKAGE_VERSION=${GIT_TAG<span class="p">:</span>-${FALLBACK_TAG<span class="p">:</span>-default}}<span class="w">
</span><span class="w">              </span><span class="k">echo Version used in setup.py</span><span class="p">:</span><span class="w"> </span>$PACKAGE_VERSION<span class="w">
</span><span class="w">
</span><span class="w">              </span><span class="c"># Use PACKAGE_VERSION in setup()</span><span class="w">
</span><span class="w">              </span>python<span class="w"> </span>setup.py<span class="w"> </span>bdist_wheel<span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Build<span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">task</span><span class="p">:</span><span class="w"> </span>CopyFiles@<span class="m">2</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>Copy<span class="w"> </span>dist<span class="w"> </span>files<span class="w">
</span><span class="w">            </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">sourceFolder</span><span class="p">:</span><span class="w"> </span>dist/<span class="w">
</span><span class="w">              </span><span class="k">contents</span><span class="p">:</span><span class="w"> </span>demo<span class="cp">*.whl</span><span class="w">
</span><span class="w">              </span><span class="k">targetFolder</span><span class="p">:</span><span class="w"> </span>$(Build.ArtifactStagingDirectory)<span class="w">
</span><span class="w">              </span><span class="k">flattenFolders</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">task</span><span class="p">:</span><span class="w"> </span>PublishBuildArtifacts@<span class="m">1</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>PublishArtifact<span class="w">
</span><span class="w">            </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">pathtoPublish</span><span class="p">:</span><span class="w"> </span>$(Build.ArtifactStagingDirectory)<span class="w">
</span><span class="w">              </span><span class="k">ArtifactName</span><span class="p">:</span><span class="w"> </span>demo.whl<span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">task</span><span class="p">:</span><span class="w"> </span>TwineAuthenticate@<span class="m">1</span><span class="w">
</span><span class="w">            </span><span class="k">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">artifactFeed</span><span class="p">:</span><span class="w"> </span>$(project)/$(feed)<span class="w">
</span><span class="w">
</span><span class="w">          </span>- <span class="k">script</span><span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">              twine upload -r $(feed) --config-file $(PYPIRC_PATH) dist/*</span><span class="w">
</span><span class="w">            </span><span class="k">displayName</span><span class="p">:</span><span class="w"> </span>PublishFeed<span class="w">
</span></code></pre></div><p>In the <code>Test</code> stage we install the project in the pipeline container, without creating a virtual environment. We then run the <code>make lint</code> and <code>make test</code> commands, just like you would on your machine.</p>
<p>In the <code>Build</code> stage we will try to extract the package version from a git tag, and we construct a fallback package version. We run the <code>python setup.py bdist_wheel</code> command to build a wheel, knowing that our package version environment variable is set. Finally, we publish the artifact to Azure DevOps artifacts, and (optionally) to our feed.</p>
<p>You&rsquo;ll need a <code>.pypirc</code> file to publish your package to a feed, you can copy the contents after creating a feed in Azure DevOps, which looks something like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="p">[</span><span class="n">distutils</span><span class="p">]</span>
<span class="n">Index</span><span class="o">-</span><span class="n">servers</span> <span class="o">=</span>
  <span class="n">stefanschenk</span>

<span class="p">[</span><span class="n">stefanschenk</span><span class="p">]</span>
<span class="n">Repository</span> <span class="o">=</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">pkgs</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">azure</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">stefanschenk</span><span class="o">/</span><span class="n">_packaging</span><span class="o">/</span><span class="n">stefanschenk</span><span class="o">/</span><span class="n">pypi</span><span class="o">/</span><span class="n">upload</span>
</code></pre></div><p>On how to install packages from a private feed, have a look at <a href="https://menziess.github.io/howto/install/python-packages-from-azure-devops/">this post</a>.</p>

</div>

<div class="content">
  
  <span class="post-meta">
    
      <a href="/tags/packaging">#packaging</a>&nbsp;
    
      <a href="/tags/devops">#devops</a>&nbsp;
    
      <a href="/tags/python">#python</a>&nbsp;
    
  </span>
  <br>
  <br>


  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "menziess" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  

</div>


        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">

        <div class="employer">
  
  <a href="https://www.thenextgen.nl/contact?ref=https://menziess.github.io">
    <img src="/images/logo/thenextgen.svg" alt="thenextgen">
  </a>
</div>


        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://github.com/menziess/">github</a></li>
            <li class="zerostatic"><a href="https://www.linkedin.com/in/stefanschenk/">linkedin</a></li>
            <li class="zerostatic"><a href="https://paypal.me/menziess/">help me stay awake! ☕️</a></li>
            <li class="zerostatic">
              <a href="/images/logo/bitcoin-receive-address.jpg#bc1qvn6y4htrzqjsk9ncdgx4km73kes7khkqldesxy">
                <img src="/images/logo/bitcoin.png"
                     alt="Bitcoin"
                     width="20px"
                     style="padding-bottom: 2px">
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>


  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.1237ff71925bb8625c97a9af8db4c54525258bedfd7c47493daaff723bea755e.js"></script>
  

</body>

</html>
