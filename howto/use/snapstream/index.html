<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use Snapstream - menziess blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,700|Lora:400,700|Fira+Code:300,400">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msvalidate.01" content="DF64D3472558D82FA059638FC476FF14">
  <meta name="msapplication-TileColor" content="#603cba">
  <meta name="theme-color" content="#ffffff">

  
  
  
    
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-157518256-1"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-157518256-1');
      </script>
    
  

  
  
  <link rel="stylesheet" href="/css/style.min.b4f1391d3bcccc695f42caa9da7c92b8738667b18c73d3784e61b89718ef6075.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-posts">
      <a href="/howto/">
        <span>Posts</span>
      </a>
    </li>
    
    <li class="menu-item-tags">
      <a href="/tags/">
        <span>Tags</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://menziess.github.io/howto"><img draggable="false" alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://menziess.github.io/howto"><img draggable="false" alt="Logo" src="/images/logo.svg" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-posts">
      <a href="/howto/">
        <span>Posts</span>
      </a>
    </li>
    
    <li class="menu-item-tags">
      <a href="/tags/">
        <span>Tags</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <h4>Howto</h4>

  
  <ul>
    
    <li class="active ">
      <a href="https://menziess.github.io/howto/use/snapstream/">Use Snapstream</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/manage/kafka-streams/">Manage Kafka Streams</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/create/python-executables/">Create Python Executables</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/use/key-vault-secrets-in-data-factory/">Use Key Vault Secrets In Data Factory</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/python-packages-from-azure-devops/">Install Python Packages From Azure DevOps</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/python-packages-on-azure-synapse/">Install Python Packages on Azure Synapse</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/python-packages-on-databricks/">Install Python Packages on Databricks</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/run/gui-apps-with-docker/">Run GUI Apps With Docker</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/run/databricks-notebooks-from-devops/">Run Databricks Notebooks from DevOps</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/parameterize/databricks-notebooks/">Parameterize Databricks Notebooks</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/use/functional-programming-in-python/">Use Functional Programming In Python</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/enhance/your-databricks-workflow/">Enhance Your Databricks Workflow</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/create/python-packages/">Create Python Packages</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/enhance/your-python-vscode-workflow/">Enhance Your Python-vscode Workflow</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/databricks-connect/">Install databricks-connect</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/install/windows-subsystem-for-linux/">Install Windows Subsystem for Linux</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/test/python-code/">Test Python Code</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/test/code-in-databricks-notebooks/">Test Code in Databricks Notebooks</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/manage/virtual-environments/">Manage Virtual Environments</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/manage/python-versions/">Manage Python Versions</a>
    </li>
    
    <li class="">
      <a href="https://menziess.github.io/howto/create/a-blog/">Create a Blog</a>
    </li>
    
  </ul>
  

</div>

          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Use Snapstream</h1>
<div class="pb-2 content anchor-link-enabled">
  <p>One of the more challenging aspects I encountered while working with stream processing was the task of performing near-merge or as-of joins on Kafka streams.</p>
<p>Especially when topics exist on multiple Kafka clusters, ruling out the option to connect and subscribe to multiple topics using a single consumer.</p>
<p><img src="/images/logo/snapstream.png#logo" alt=""> ‚ü∂ <img src="/images/logo/kafka.png#logo" alt=""></p>
<h2 id="arbitrary-stateful-operations">Arbitrary Stateful Operations</h2>
<p>Some frameworks seem promising at first, mentioning &ldquo;joining or merging&rdquo; of event streams in the documentation. Or declaring support for arbitrary operations.</p>
<p>In my experience however, the following occurs:</p>
<ol>
<li>Read documentation, determine that stream joins/merges are supported</li>
<li>Adopt and prototype solution</li>
<li>Conclude that features are only supported in a limited scope</li>
</ol>
<p>As a consequence, the functionalities that support arbitrary stateful operations (like nearby joining of topics) were implemented in-house.</p>
<p>The reusable data-flow model was open-sourced under the name <a href="https://github.com/Menziess/snapstream">Snapstream</a>.</p>
<h2 id="snapstream">Snapstream</h2>
<p>If you want to follow along, run a Kafka broker as shown in the <a href="https://menziess.github.io/howto/manage/kafka-streams/#basic-setup">previous post</a>, and install snapstream:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">pip install snapstream
</span></span></code></pre></div><p>The basic concepts are:</p>
<ol>
<li>Each data source is an iterable</li>
<li>Each sink is a callable</li>
<li><code>snap</code> is used to bind sources and sinks to user defined handler functions</li>
<li><code>stream</code> is used to process each iterable in parallel</li>
</ol>
<p>As you can see, the Topic <code>t</code> is both an iterable and a callable:</p>
<p><img src="/images/use-snapstream/demo.gif#shadow" alt=""></p>
<h3 id="state-store">State Store</h3>
<p>When the processing logic of your stream solely relies on the message itself, without requiring any additional data, it is referred to as &ldquo;stateless processing&rdquo;.</p>
<p>Any other type of processing usually involves caching and retrieving state. RocksDB is a popular state store that&rsquo;s used in Spark, KsqlDB, Faust and other popular frameworks (including Snapstream). We can use <a href="https://snapstream.readthedocs.io/en/0.0.5/examples.html#cache">snapstream.Cache</a> to persist any type of data:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">snapstream</span> <span class="kn">import</span> <span class="n">Cache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># value &#39;üèÜ&#39; is stored under the key &#39;prize&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">cache</span><span class="p">(</span><span class="s1">&#39;prize&#39;</span><span class="p">,</span> <span class="s1">&#39;üèÜ&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>Cache is also callable, so we can use it as our sink.</p>
<h3 id="nearby-join">Nearby Join</h3>
<p>At this point, we&rsquo;re ready to perform some type of arbitrary operation on our data:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">weather_messages</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;üåû&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;‚õÖ&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;üåß&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">activity_messages</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;swimming&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;walking home&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;shopping&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;lunch&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span></code></pre></div><p>Let&rsquo;s try and figure out the weather at the time of each activity:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">snapstream</span> <span class="kn">import</span> <span class="n">Cache</span><span class="p">,</span> <span class="n">snap</span><span class="p">,</span> <span class="n">stream</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">weather_cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="s1">&#39;weather&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@snap</span><span class="p">(</span><span class="n">weather_messages</span><span class="p">,</span> <span class="n">sink</span><span class="o">=</span><span class="p">[</span><span class="n">weather_cache</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handle_weather</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_time</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">yield</span> <span class="n">event_time</span><span class="p">,</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@snap</span><span class="p">(</span><span class="n">activity_messages</span><span class="p">,</span> <span class="n">sink</span><span class="o">=</span><span class="p">[</span><span class="nb">print</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handle_activity</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_time</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">weather</span> <span class="ow">in</span> <span class="n">weather_cache</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">backwards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">from_key</span><span class="o">=</span><span class="n">event_time</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">weather</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">stream</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;swimming&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;walking home&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;shopping&#39;</span><span class="p">,</span> <span class="s1">&#39;‚õÖ&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;lunch&#39;</span><span class="p">,</span> <span class="s1">&#39;üåß&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>What we just did:</p>
<ol>
<li>We cached weather messages by event time in our <code>handle_weather</code> function</li>
<li>We looked up the last known (nearest) weather message since time of the activity in our <code>handle_activity</code> function</li>
</ol>
<p>Now you might be wondering two things&hellip;</p>
<h4 id="1-wheres-kafka">1. Where&rsquo;s Kafka?</h4>
<p>The generators can easily be replaced with <code>Topic</code> instances:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">snapstream</span> <span class="kn">import</span> <span class="n">Topic</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">snapstream.codecs</span> <span class="kn">import</span> <span class="n">JsonCodec</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">weather_messages</span> <span class="o">=</span> <span class="n">Topic</span><span class="p">(</span><span class="s1">&#39;weather&#39;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;bootstrap.servers&#39;</span><span class="p">:</span> <span class="s1">&#39;localhost:29091&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;auto.offset.reset&#39;</span><span class="p">:</span> <span class="s1">&#39;earliest&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;group.instance.id&#39;</span><span class="p">:</span> <span class="s1">&#39;weather&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;group.id&#39;</span><span class="p">:</span> <span class="s1">&#39;weather&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">},</span> <span class="n">codec</span><span class="o">=</span><span class="n">JsonCodec</span><span class="p">())</span>
</span></span></code></pre></div><p>Change the handler so that it gets the value from the Kafka message object:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="nd">@snap</span><span class="p">(</span><span class="n">weather_messages</span><span class="p">,</span> <span class="n">sink</span><span class="o">=</span><span class="p">[</span><span class="n">weather_cache</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handle_weather</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>  <span class="c1"># grab the value from the Kafka message</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_time</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">yield</span> <span class="n">event_time</span><span class="p">,</span> <span class="n">val</span>
</span></span></code></pre></div><h4 id="2-what-about-late-events">2. What About Late Events?</h4>
<p>When we move <code>sleep(0.1)</code> from the <code>handle_activity</code> into the <code>handle_weather</code> function, we will cause weather updates to arrive later than activity events.</p>
<p><img src="/images/use-snapstream/event-process-time.png#medium" alt=""></p>
<p>Imagine if the &ldquo;Cloudy&rdquo; and &ldquo;Rainy&rdquo; events had a bit of a delay. If we did nothing, we&rsquo;d send out incorrect weather states for the &ldquo;Shopping&rdquo; and &ldquo;Lunch&rdquo; activities:</p>
<p><img src="/images/use-snapstream/nothing.png#large" alt=""></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;swimming&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;walking home&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;shopping&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>  <span class="c1"># incorrect</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;lunch&#39;</span><span class="p">,</span> <span class="s1">&#39;‚õÖ&#39;</span><span class="p">)</span>     <span class="c1"># incorrect</span>
</span></span></code></pre></div><p>We could defer processing so that late events can be joined succesfully, which has its <a href="https://www.confluent.io/blog/watermarks-tables-event-time-dataflow-model">downsides</a>:</p>
<p><img src="/images/use-snapstream/defer.png#large" alt=""></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;swimming&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;walking home&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># defer &#39;shopping&#39; event</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;shopping&#39;</span><span class="p">,</span> <span class="s1">&#39;‚õÖ&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># defer &#39;lunch&#39; event</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;lunch&#39;</span><span class="p">,</span> <span class="s1">&#39;üåß&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>Or we could choose to send out revisions on incorrect results, would work great together with Kafka&rsquo;s log compaction:</p>
<p><img src="/images/use-snapstream/revision.png#large" alt=""></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;swimming&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;walking home&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;shopping&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>  <span class="c1"># incorrect</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;shopping&#39;</span><span class="p">,</span> <span class="s1">&#39;‚õÖ&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;lunch&#39;</span><span class="p">,</span> <span class="s1">&#39;‚õÖ&#39;</span><span class="p">)</span>     <span class="c1"># incorrect</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;lunch&#39;</span><span class="p">,</span> <span class="s1">&#39;üåß&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h5 id="code">Code</h5>
<p>Taking this last option as an example, we could implement it using another cache for activities together with python&rsquo;s <code>queue</code> module:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">revisions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span></span></code></pre></div><p>By storing all activities in a cache, we can look up the ones that need a revision later. We&rsquo;re also &ldquo;snapping&rdquo; the new <code>revisions()</code> iterable to the activity handler function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">activity_cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="s1">&#39;activity&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@snap</span><span class="p">(</span><span class="n">activity_messages</span><span class="p">,</span> <span class="n">revisions</span><span class="p">(),</span> <span class="n">sink</span><span class="o">=</span><span class="p">[</span><span class="n">activity_cache</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handle_activity</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_time</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">yield</span> <span class="n">event_time</span><span class="p">,</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">weather</span> <span class="ow">in</span> <span class="n">weather_cache</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">backwards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">from_key</span><span class="o">=</span><span class="n">event_time</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">((</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">weather</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span></code></pre></div><p>When a late arriving weather update comes in, we can cache it like normal. In addition, we can find any activities that occured after the weather event time, and put them in the queue:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="nd">@snap</span><span class="p">(</span><span class="n">weather_messages</span><span class="p">,</span> <span class="n">sink</span><span class="o">=</span><span class="p">[</span><span class="n">weather_cache</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handle_weather</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># cause late events</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_time</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">yield</span> <span class="n">event_time</span><span class="p">,</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">activity_cache</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">from_key</span><span class="o">=</span><span class="n">event_time</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">activity</span><span class="p">)</span>
</span></span></code></pre></div><p>Kafka handles messages within the same partition in the order in which they arrived. By putting the activities in the queue, the <code>handle_activity</code> function is called with the same activities, but now the correct weather updates will be available in the weather cache:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;swimming&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;walking home&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;shopping&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>  <span class="c1"># incorrect</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;lunch&#39;</span><span class="p">,</span> <span class="s1">&#39;üåû&#39;</span><span class="p">)</span>     <span class="c1"># incorrect</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;shopping&#39;</span><span class="p">,</span> <span class="s1">&#39;‚õÖ&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;lunch&#39;</span><span class="p">,</span> <span class="s1">&#39;‚õÖ&#39;</span><span class="p">)</span>     <span class="c1"># incorrect</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="s1">&#39;lunch&#39;</span><span class="p">,</span> <span class="s1">&#39;üåß&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>There will be trade-offs; with lots of late weather updates there would also be lots of revisions.</p>

</div>

<div class="content">
  
  <span class="post-meta">
    
      <a href="/tags/kafka">#kafka</a>&nbsp;
    
      <a href="/tags/python">#python</a>&nbsp;
    
  </span>
  <br>
  <br>


  <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "menziess" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  

</div>


        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">

        <div class="employer">
  
  <a href="https://www.thenextgen.nl/contact?ref=https://menziess.github.io">
    <img src="/images/logo/thenextgen.svg" alt="thenextgen">
  </a>
</div>


        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://github.com/menziess/">github</a></li>
            <li class="zerostatic"><a href="https://www.linkedin.com/in/stefanschenk/">linkedin</a></li>
            <li class="zerostatic"><a href="https://paypal.me/menziess/">help me stay awake! ‚òïÔ∏è</a></li>
            <li class="zerostatic">
              <a href="/images/logo/bitcoin-receive-address.jpg#bc1qvn6y4htrzqjsk9ncdgx4km73kes7khkqldesxy">
                <img src="/images/logo/bitcoin.png"
                     alt="Bitcoin"
                     width="20px"
                     style="padding-bottom: 2px">
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>


  

  
  

  
  <script type="text/javascript" src="/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js"></script>
  

</body>

</html>
